---
import type { FeaturedSeriesItem } from '@lib/config/types';
import { getLqipStyle } from '@lib/lqip';
import { getSanitizeHtml } from '@lib/sanitize';
import { Icon } from 'astro-icon/components';
import { marked } from 'marked';
import { MAX_WIDTH } from '@/constants/layout';
import WaveSvg from './wave';

interface Props {
  series: FeaturedSeriesItem;
}

const { series } = Astro.props;

// Extract links for template type narrowing
const links = series.links;

// Convert Markdown description to HTML and sanitize for XSS protection
const rawHtml = series.description ? await marked.parse(series.description) : '';
const descriptionHtml = getSanitizeHtml(rawHtml);
---

<div class="relative flex z-0 max-h-200 min-h-[70dvh] items-center justify-center overflow-hidden pb-6">
  <div class="absolute inset-0 h-full bg-black/40"></div>
  <!-- Series cover image -->
  {
    series.cover && (
      <div class="absolute inset-0 -z-10 h-full w-full" style={getLqipStyle(series.cover)}>
        <img
          src={series.cover}
          alt={series.fullName ?? series.label}
          class="h-full w-full object-cover"
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
      </div>
    )
  }

  <!-- Main content area -->
  <div class={`relative z-10 flex flex-col items-center justify-center px-5 py-4 text-white ${MAX_WIDTH.content}`}>
    <!-- Title -->
    <h1 class="shadow-text text-center text-5xl font-bold md:text-3xl">
      {series.fullName ?? series.label ?? series.categoryName}
    </h1>

    <!-- Link buttons -->
    {
      links && (
        <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
          {links?.pixiv && (
            <a
              href={links?.pixiv}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all
          hover:scale-105 hover:bg-white/20"
            >
              <Icon name="simple-icons:pixiv" class="h-5 w-5" />
              <span>Pixiv</span>
            </a>
          )}
          {links?.fanbox && (
            <a
              href={links?.fanbox}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all
          hover:scale-105 hover:bg-white/20"
            >
              <img src="img/icon/fanbox.png" width="20" height="20" />
              <span>Fanbox</span>
            </a>
          )}
          {links?.patreon && (
            <a
              href={links?.patreon}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="simple-icons:patreon" class="h-4 w-4" />
              <span>Patreon</span>
            </a>
          )}
          {links?.southplus && (
            <a
              href={links?.southplus}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all
          hover:scale-105 hover:bg-white/20"
            >
              <img src="img/icon/southplus.ico" width="20" height="20" style="border-radius: 5px;" />
              <span>Southplus</span>
            </a>
          )}
          {links?.github && (
            <a
              href={links?.github}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:github-fill" class="h-5 w-5" />
              <span>GitHub</span>
            </a>
          )}
          {links?.rss && (
            <a
              href={links?.rss}
              target="_blank"
              data-astro-reload
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:rss-line" class="h-5 w-5" />
              <span>RSS 订阅</span>
            </a>
          )}
          {links?.chrome && (
            <a
              href={links?.chrome}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:chrome-fill" class="h-5 w-5" />
              <span>Chrome 插件</span>
            </a>
          )}
          {links?.docs && (
            <a
              href={links?.docs}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:book-open-line" class="h-5 w-5" />
              <span>插件文档</span>
            </a>
          )}
        </div>
      )
    }

    <!-- Description -->
    {
      series.description && (
        <div class="shadow-text mt-8 max-w-3xl text-center">
          <div class="prose prose-invert mx-auto text-sm leading-relaxed md:text-xs" set:html={descriptionHtml} />
        </div>
      )
    }
  </div>

  <WaveSvg />
</div>
